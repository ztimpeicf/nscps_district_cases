---
title: "Analysis #2: District policy and health department-reported case data"
format: 
  html:
    page-layout: full
    self-contained: true  
    mainfont: "Times New Roman"
    theme: journal
editor: visual
---

```{r}
#| echo: false
#| include: false
library(DT)
library(dplyr)
library(tidyr)
readRDS("raw_summary_statistics.rds")%>%
  list2env(envir=.GlobalEnv)

readRDS("output_tables.rds")%>%
  list2env(envir=.GlobalEnv)

readRDS("forest_list_statistics.rds")%>%
  list2env(envir=.GlobalEnv)
```

# Introduction

The purpose of this analysis is to study the effectiveness of school districts' COVID-19 prevention strategies in mitigating the spread of COVID-19 among school-aged children and adolescents.

As such, the primary research question is, what is the association between districts' COVID-19 prevention policies and subsequent COVID-19 caseloads in schools?

# Methods

## Data

This research utilizes school-level COVID-19 case counts and district policy guidance data collected as part of the National School COVID-19 Prevention Study (NSCPS), funded by the Centers for Disease Control and Prevention (CDC). The NSCPS is a nationally representative stratified random sample of 1,602 K-12 public schools across 1,286 districts, drawn to better understand schools' response to the pandemic through the 2021-2022 school year and associated outcomes, including the extent to which prevention strategies were effective in mitigating the spread of COVID-19 among students. As part of the NSCPS, the team scraped and analyzed publicly-posted guidance documents from district websites to identify strategies that were recommended or required of schools. In addition, health departments representing all 50 states and the District of Columbia were contacted and invited to provide any available COVID-19 case count data for the 2021-2022 school year that had been collected from schools comprising the sample.

## Measures

**Outcome of interest**: The difference between schools' spring and fall monthly average case counts, characterized as the average of schools' monthly number of cases per 100 students across January, February, and March 2022 minus the average of October, November, and December 2021 monthly cases per 100 students.

**Independent variables:** The key predictors of interest consist of 10 dichotomous indicators of COVID-19 mitigation strategies aligned as stringently with CDC guidance as possible. Furthermore, a mitigation strategy was considered in place if it was on the district website and had been updated during fall of 2021. These 10 strategy indicators include:

-   *Vaccination offered*: Offered vaccines at district-sponsored events to teachers and staff and/or students.
-   *Universal masking requirement*: Teachers, staff, and students required to wear masks consistently and correctly (i.e., covering the mouth and nose) at school.
-   *Physical distancing*: Students maintain at least 3 feet of physical distance between each other indoors.
-   *Screening testing for students*: Encouraged/recommended/offered screening testing of students on a regular basis.
-   *Staying home when sick*: Encouraged or recommended that students stay home when sick or tested positive for COVID-19.
-   *Contact tracing*: Encouraged or recommended that schools conduct contact tracing.
-   *Quarantine*: Required students to quarantine if identified to be a close contact.
-   *Cleaning*: Required schools to clean high touch surfaces at least once a day or between uses.
-   *HEPA filters*: Encouraged/recommended/offered use of high-efficiency particulate air (HEPA) filters.
-   *HVAC systems*: Encouraged/recommended/offered replacing, upgrading, maintaining, or inspecting HVAC systems.

*School-level characteristics*

-   *Percent student body eligible for free and reduced lunch*: The percent of the schools' students who were eligible or free and reduced lunch
-   *School locale*: City, Rural, Suburb, Town, Missing
-   *Percent of student body Asian, American Indian or Alaska Native, Black/African American, Hispanic/Latino, Native Hawaiian or other Pacific Islander, Not specific, Two or more races, and White (each race/ethnicity represented individually)*

*County-level characteristics*

-   *Social Vulnerability Index (SVI)*: Overall summary index indicating the relative vulnerability of U.S. Census tracts across four themes: socioeconomic, household composition & disability, minority status & language, and housing type & transportation
-   *Change in county COVID-19 case rates*: Difference in average of 7-day rolling average for the 15th of each month case rate per 100,000 people between October - December and January - March, corresponding with the time period used for calculating school case rate changes
-   *Region*: Midwest, Northeast, South, West
-   *State*: 20 states (should we list them?)

## Analyses

In total, policy documents from 1,184 of 1,286 (92%) of the districts were collected. Twenty of the 51 health departments provided case count data for 332 (CONFIRM) of the 1,602 schools (21%). Schools without at least one month of reporting during the spring and fall periods were dropped, with listwise deletion across the explanatory variables. This resulted in a final analytic sample of 332 across 20 states and X districts.

All analyses were conducted using R version 4.2.1. Prior to modeling, potential outliers with respect to average cases per 100 students were identified by calculating influence diagnostics, including Cook's Distance and difference in fits (DFFITS) (cite). Of the 332 schools, 17 had high values relative to the average () and were therefore dropped from subsequent analyses. Following removal of outliers, summary statistics were calculated, as well as t-tests for mean differences between groups defined by the presence of the strategy guidance during the fall 2021 semester and Pearson's correlation coefficient between changes in case rates per 100 students and continuous outcomes.

The final modeling sequence consisted of two stages, first developing Random Forest algorithms for identifying the most predictive covariates and strategies in the event that sample size required estimation of fewer parameters; and secondly estimating a series of multilevel regression models beginning with a set of models where covariates and one strategy is included, and finally a full model including all relevant covariates and individual strategies of interest. Random Forest algorithms are useful for ranking variables based on their predictive association with the outcome of interest. Due to limited sample size, it was important to a priori exclude the least relevant predictors. As such, we developed two machine learning models to rank covariates and strategies (separately) on their importance in predicting changes in case rates. The machine learning models were developed using *cforest* and then variables were ranked using *varimp*, both functions coming from the *party* package. For each set of predictors, the models were estimated 100 times, with the overall ranking computed as the percentage of iterations where a predictor ranked among the top five in importance. Multilevel modeling will account for the potential nesting of schools within districts, states, and region.

# Results

Table 1 provides summary statistics, including Pearson's correlation coefficient, for the change in case rate and covariates. Three hundred thirty-two schools had available case data for fall and spring, with an average of 1.51 more cases per month during the spring of 2022 than fall 2021. Suprisingly, none of the school-level covariates were significantly associated with changes in cases per 100 students.

```{r}
#| echo: false
tbl1 %>%
   DT::datatable(rownames = FALSE,colnames=c("n (min, max)"='min_max',"Mean (median)"="mean_median", "Correlation (p-value)"="est_pval"),
                 style="bootstrap4",
                 caption = "Table 1: Summary statistics of changes in case rates and standardized covariates",
                extensions = 'Buttons', options = list(
                  pageLength=nrow(tbl1),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

Table 2 reviews summary statistics and t-test results of the 10 prevention strategies, all dichotomized with a score of one if the district guidance was updated during the fall 2021 semester and met the criterion identified in the measures section above.

```{r}
#| echo: false
tbl4 %>%
   DT::datatable(rownames = FALSE,colnames=c("n (min, max)"='min_max',"Mean (ST Dev)"="mean_stdev", "Difference in means (p-value)"="t_estimate", 'No policy'='No policy_mean','Has policy'='Has policy_mean'),
                 style="bootstrap4",
                 caption = "Table 4: Summary statistics and t-test results of policies dichotimized by scoring at or above 75th percentile",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl4),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

Tables three and four review results of the Random Forest machine learning algorithms, corresponding with covariate and strategy importance rankings, respectively.

```{r}
#| echo: false
tbl5 %>%
   DT::datatable(rownames = FALSE,
                 style="bootstrap4",
                 caption = "Table 5: Covariate importance results from machine learning models",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl5),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

```{r}
#| echo: false
tbl6 %>%
   DT::datatable(rownames = FALSE,
                 style="bootstrap4",
                 caption = "Table 6: Strategy importance results from machine learning models",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl6),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

Table five shows results of individual for strategy predictors. Four of the 10 strategies were a top five predictor at least 40% of the iterations. This includes vaccination (100% of the iterations), testing and/or screening (99%), physical distancing (51%), and cohorting and/or staggering (47%). Cleaning strategies were only important 6% of the iterations, and staying home was never an important predictor.

# Discussion
