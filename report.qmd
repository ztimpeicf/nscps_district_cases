---
title: "Analysis #2: District policy and health department-reported case data"
format: 
  html:
    page-layout: full
    self-contained: true  
    mainfont: "Times New Roman"
    theme: journal
editor: visual
---

```{r}
#| echo: false
#| include: false
library(DT)
library(dplyr)
library(tidyr)
readRDS("raw_summary_statistics.rds")%>%
  list2env(envir=.GlobalEnv)

readRDS("output_tables.rds")%>%
  list2env(envir=.GlobalEnv)

readRDS("forest_list_statistics.rds")%>%
  list2env(envir=.GlobalEnv)
```

# Introduction

The purpose of this analysis is to study the effectiveness of school districts' COVID-19 prevention strategies in mitigating the spread of COVID-19 among school-aged children and adolescents.

As such, the primary research question is, what is the association between districts' COVID-19 prevention policies and subsequent COVID-19 caseloads in schools?

# Methods

## Data

This research utilizes school-level COVID-19 case counts and district policy guidance data collected as part of the National School COVID-19 Prevention Study (NSCPS), funded by the Centers for Disease Control and Prevention (CDC). The NSCPS is a nationally representative stratified random sample of 1,602 K-12 public schools across 1,286 districts, drawn to better understand schools' response to the pandemic through the 2021-2022 school year and associated outcomes, including the extent to which prevention strategies were effective in mitigating the spread of COVID-19 among students. As part of the NSCPS, publicly-posted guidance documents from district websites were scraped and analyzed to identify prevention strategies that were recommended or required of schools. In addition, health departments representing all 50 states and the District of Columbia were contacted and invited to provide any available COVID-19 case count data for the 2021-2022 school year that had been collected from schools comprising the sample.

## Measures

**Outcome of interest**: The outcome of interest is the difference between schools' spring and fall monthly average case counts, characterized as the average of schools' monthly number of cases per 100 students across January, February, and March 2022 minus the average of October, November, and December 2021 monthly cases per 100 students.

**Independent variables:** The key predictors of interest consist of 10 dichotomous indicators of COVID-19 mitigation strategies aligned as stringently with CDC guidance as possible[ADD FURTHER DESCRIPTION OF CDC GUIDANCE AND HOW WE ALIGNED WITH IT]. Furthermore, a mitigation strategy was considered in place if it was on the district website and had been updated during fall of 2021. These 10 strategy indicators include:

-   *Vaccination offered*: Offered vaccines at district-sponsored events to teachers and staff and/or students.
-   *Universal masking requirement*: Teachers, staff, and students required to wear masks consistently and correctly (i.e., covering the mouth and nose) at school.
-   *Physical distancing*: Students maintain at least 3 feet of physical distance between each other indoors.
-   *Screening testing for students*: Encouraged/recommended/offered screening testing of students on a regular basis.
-   *Staying home when sick*: Encouraged or recommended that students stay home when sick or tested positive for COVID-19.
-   *Contact tracing*: Encouraged or recommended that schools conduct contact tracing.
-   *Quarantining*: Required students to quarantine if identified to be a close contact.
-   *Cleaning*: Required schools to clean high touch surfaces at least once a day or between uses.
-   *HEPA filters*: Encouraged/recommended/offered use of high-efficiency particulate air (HEPA) filters.
-   *HVAC systems*: Encouraged/recommended/offered replacing, upgrading, maintaining, or inspecting HVAC systems.

*School-level characteristics*

-   *Percent student body eligible for free and reduced lunch*: The percent of the schools' students who were eligible or free and reduced lunch
-   *School locale*: City, Rural, Suburb, Town, Missing
-   *Percent of student body Asian, American Indian or Alaska Native, Black/African American, Hispanic/Latino, Native Hawaiian or other Pacific Islander, Not specific, Two or more races, and White (each race/ethnicity represented individually)*

*County-level characteristics*

-   *Social Vulnerability Index (SVI)*: Overall summary index indicating the relative vulnerability of U.S. Census tracts across four themes: socioeconomic, household composition & disability, minority status & language, and housing type & transportation
-   *Change in county COVID-19 case rates*: Difference in average of 7-day rolling average for the 15th of each month case rate per 100,000 people between October - December and January - March, corresponding with the time period used for calculating school case rate changes
-   *Region*: Midwest, Northeast, South, West
-   *State*: 20 states (should we list them?)

## Analyses

In total, policy documents from 1,184 of 1,286 (92%) of the districts were collected, with twenty of the 51 health departments reporting on 641 schools (40% of sample). Schools without at least one month of reporting during the spring and fall periods were dropped, resulting in an initial sample of 347 schools (22% of sample) across 338 districts.

All analyses were conducted using R version 4.2.1. The analysis begins descriptively, presenting summary statistics for all study variables, as well as t-tests for mean differences between groups defined by the presence of mitigation strategy guidance updated the fall 2021 semester, and Pearson's correlation coefficient between changes in case rates per 100 students and continuous covariates. All continuous covariates were standardized.

Following the descriptive analysis, the modeling sequence consists of two stages, first developing Random Forest (RF) algorithms for identifying the most predictive covariates and strategies, and secondly a series of three-level multilevel models to account for schools nested within states, nested within region. First, Random Forest algorithms can be used to rank variables based on their predictive association with the outcome of interest, and due to limited sample size for the current study, it was important to a priori exclude covariates with no predictive value. Ranking covariates consisted of 100 iterations of the RF and selecting covariates having a positive
variable importance for at least 40% of the iterations.

The second stage of analysis is comprised of two sets of models, including individual multilevel models with one strategy and important covariates as predictors (nested within state and region), followed by a multilevel model with all strategies and important covariates.

# Results

Table 1 provides summary statistics, including Pearson's correlation coefficient, for the outcome variable and covariates. Three hundred forty-seven schools had case data available for fall and spring, with an overall average of 1.30 more cases per month during the spring of 2022 than fall 2021. Surprisingly, none of the school-level covariates were significantly associated with changes in cases per 100 students.

```{r}
#| echo: false
tbl1 %>%
   DT::datatable(rownames = FALSE,colnames=c("n (min, max)"='min_max',"Mean (median)"="mean_median", "Correlation (p-value)"="est_pval"),
                 style="bootstrap4",
                 caption = "Table 1: Summary statistics of changes in case rates and standardized covariates",
                extensions = 'Buttons', options = list(
                  pageLength=nrow(tbl1),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

Table 2 reviews summary statistics and t-test results of the 10 prevention strategies, all dichotomized with a score of one if the district guidance was updated during the fall 2021 semester and met the criterion identified in the measures section above. The mean represents the percentage of schools scoring a one for the policy of interest. *No policy* provides the mean change in cases among schools not having the policy, whereas *Has policy* indicates the mean change in cases among schools having the policy. *Difference in means* provides the mean difference between groups, along with p-values from t-tests, with a signficance threshold of $\alpha = .05$. Overall, policies were associated with decreased change in cases. Significant differences were detected between schools dependent on having a district policy of physical distancing (mean difference = .88 cases; p-value = .02), and HVAC systems (.86; .007), with a marginal difference associated with quarantining (.98; .059). 

```{r}
#| echo: false
tbl2 %>%
   DT::datatable(rownames = FALSE,colnames=c("n (min, max)"='min_max',"Mean (ST Dev)"="mean_stdev", "Difference in means (p-value)"="t_estimate", 'No policy'='No policy_mean','Has policy'='Has policy_mean'),
                 style="bootstrap4",
                 caption = "Table 4: Summary statistics and t-test results of policies dichotimized by scoring at or above 75th percentile",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl2),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

Table three reviews results of the Random Forest machine learning algorithms, corresponding with covariate and strategy importance rankings, respectively. State and region were ranked as an important variable in 100% and 98% of iterations, respectively. The only other covariates to be important at least 40% of the iterations were percent student population being two or more races (46%) and percent student population free lunch qualified (40%).

```{r}
#| echo: false
tbl3 %>%
   DT::datatable(rownames = FALSE,
                 style="bootstrap4",
                 caption = "Table 5: Covariate importance results from machine learning models",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl3),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```
Table four reviews results of the RF models for the strategy predictors. All strategies were an important predictor, though there is a clear dropoff between the top four and bottom six. Specifically, Contact tracing and HVAC system policies were an important predictor 98% of iterations, followed by cleaning (77%), and screening and testing for students (57%). The other six included quarantining (25%), universal masking requirements (16%), physical distancing and vaccination offered (both 14%), HEPA filters (8%), and staying home when sick (3%).
```{r}
#| echo: false
tbl4 %>%
   DT::datatable(rownames = FALSE,
                 style="bootstrap4",
                 caption = "Table 6: Strategy importance results from machine learning models",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl4),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```

Table five shows results of multilevel models run individually for each strategy with important covariates. None of the strategies were statistical and significantly associated with changes in case rates. 
```{r}
#| echo: false
tbl5 %>%
   DT::datatable(rownames = FALSE,
                 style="bootstrap4",
                 caption = "Table 5: MLM Results",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl5),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```
Table six shows multilevel model results from including all strategies as predictors in one model. Overall, the only predictor to be signficantly associated with changes in case rates was percent of students free lunch qualified (-0.328; 95% CI: -.64 - -.003).
```{r}
#| echo: false
tbl6 %>%
   DT::datatable(rownames = FALSE,
                 style="bootstrap4",
                 caption = "Table 5: MLM Results",
                extensions = 'Buttons', options = list(
    pageLength=nrow(tbl6),
    dom = 'tB',
    buttons = c('excel', 'copy'))
                 )
```
# Discussion
